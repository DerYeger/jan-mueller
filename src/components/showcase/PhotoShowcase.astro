---
import type { PhotoData } from '~/components/showcase/Photo.astro'
import Photo from '~/components/showcase/Photo.astro'
import Showcase from '~/components/showcase/Showcase.astro'
import { cn } from '~/components/ui/cn'

const photos: PhotoData[] = [
  {
    src: import('~/assets/photos/2024-08-19__helsinki-klippan.jpg'),
    alt: (location) => `Luoto island in ${location}.`,
    location: 'Helsinki, Finland',
  },
  {
    src: import('~/assets/photos/2024-07-06__heron-on-lake-in-forest.jpeg'),
    alt: (location) => `Heron on the Silver Lake in ${location}.`,
    location: 'Vienna, Austria',
  },
  {
    src: import('~/assets/photos/2024-06-29__sunflower-field.jpeg'),
    alt: (location) => `Sunflower field next to ${location}.`,
    location: 'MÃ¶dling, Austria',
  },
  {
    src: import('~/assets/photos/2024-04-15__pigeon-in-tree-looking-at-camera.jpg'),
    alt: (location) => `Pigeon in a tree, ${location}.`,
    location: 'Brunn am Gebirge, Austria',
  },
  {
    src: import('~/assets/photos/2024-05-11__purple-star-trails.jpeg'),
    alt: (location) => `Star trails during solar flare, ${location}.`,
    location: 'Semmering, Austria',
  },
]

function getNumberWithOrdinal(n: number) {
  const s = ['th', 'st', 'nd', 'rd']
  const v = n % 100
  return n + (s[(v - 20) % 10] || s[v] || s[0])
}
---

<Showcase
  name="Photos"
  class="photos group h-0 border-0 bg-transparent p-0 pb-[100%]"
>
  <div
    class="z-20 transition-opacity focus-within:opacity-100 duration-500 opacity-0 group-hover:opacity-100"
    role="presentation"
  >
    <div
      class="absolute inset-x-0 mx-auto w-fit top-2 flex justify-center bg-glass p-1 rounded-full"
    >
      {
        photos.map((_photo, index) => (
          <button
            type="button"
            class={cn('dot group/btn focus-visible:focus-ring cursor-pointer p-1 touch-manipulation rounded-full')}
            data-index={index}
            data-active={index === 0 ? 'true' : 'false'}
            title={`Show ${getNumberWithOrdinal(index + 1)} image.`}
          >
            <div class="size-2 rounded-full bg-neutral-400 dark:bg-neutral-400 group-data-[active='true']/btn:bg-neutral-600 dark:group-data-[active='true']/btn:bg-white" />
          </button>
        ))
      }
    </div>
  </div>
  {
    photos.map((photo, index) => (
      <Photo photo={photo} initial={index === 0} index={index} total={photos.length} />
    ))
  }
</Showcase>

<script>
function initialize() {
  ;[...document.getElementsByClassName('photos')].forEach((container) => {
    const images = container.getElementsByClassName('photo') as HTMLCollectionOf<HTMLImageElement>
    const length = images.length
    let timeout: number | undefined
    let current = 0

    const buttons = container.getElementsByTagName('button')

    Array.from(buttons).forEach((button) => {
      button.addEventListener('click', () => {
        const index = button.dataset.index
        if (!index) {
          return
        }
        showImage(parseInt(index, 10))
      })
    })

    container.addEventListener('pointerenter', clearQueuedImage, { passive: true })
    container.addEventListener('pointerleave', queueNextImage, { passive: true })

    container.addEventListener('touchstart', startTouchSwipe, { passive: true })
    container.addEventListener('touchend', endTouchSwipe, { passive: true })

    let touchStart: Touch | undefined

    function startTouchSwipe(event: Event) {
      event.preventDefault()
      touchStart = (event as TouchEvent).changedTouches[0]
    }

    function endTouchSwipe(event: Event) {
      if (!touchStart) {
        return
      }
      const touchEnd = (event as TouchEvent).changedTouches[0]
      const xDiff = touchEnd.screenX - touchStart.screenX
      const yDiff = touchEnd.screenY - touchStart.screenY
      touchStart = undefined
      // Must be a pronounced horizontal swipe.
      if (5 * Math.abs(yDiff) > Math.abs(xDiff)) {
        return
      }
      event.preventDefault()
      const direction = xDiff > 0 ? -1 : 1
      showImage(coerceInRange(current + direction))
      queueNextImage()
    }

    queueNextImage()

    function clearQueuedImage() {
      if (!timeout) {
        return
      }
      window.clearTimeout(timeout)
      timeout = undefined
    }

    function queueNextImage() {
      clearQueuedImage()
      timeout = window.setTimeout(() => {
        showImage(coerceInRange(current + 1))
        queueNextImage()
      }, 5000)
    }

    function showImage(index: number) {
      if (index === current) {
        return
      }
      toggleImage(current)
      toggleImage(index)
      current = index
    }

    function toggleImage(index: number) {
      images[index].dataset.active = String(buttons[index].dataset.active !== 'true')
      buttons[index].dataset.active = String(buttons[index].dataset.active !== 'true')
    }

    // Replace the modulo operator with a function that works with negative numbers.
    function coerceInRange(index: number) {
      return ((index % length) + length) % length
    }
  })
}

window.addEventListener('load', initialize, { once: true })
</script>
